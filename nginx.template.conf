worker_processes 5;
daemon off;

worker_rlimit_nofile 8192;

events {
  worker_connections  4096;  # Default: 1024
}

http {
    default_type  application/octet-stream;
    types {
        text/html               html htm shtml;
        text/css                css;
        text/xml                xml;
        image/gif               gif;
        image/jpeg              jpeg jpg;
        application/javascript  js;
        application/atom+xml    atom;
        application/rss+xml     rss;
        font/woff2              woff2;
        font/woff               woff;
        font/ttf                ttf;
        image/svg+xml           svg svgz;
        application/json         json;
        application/xml          xml;
        application/x-web-app-manifest+json webapp;
        application/xhtml+xml    xhtml;
        application/xml-dtd      dtd;
        application/x-javascript js;
        application/x-httpd-php  php;
        image/webp              webp;
        image/x-icon            ico;
        image/x-ms-bmp          bmp;
        text/cache-manifest     appcache manifest;
        text/mathml             mml;
        text/plain              txt md;
        text/vnd.sun.j2me.app-descriptor jad;
        text/vnd.wap.wml        wml;
        text/x-component        htc;
    }

    index    index.html index.htm index.php;

    log_format   main '$remote_addr - $remote_user [$time_local]  $status '
        '"$request" $body_bytes_sent "$http_referer" '
        '"$http_user_agent" "$http_x_forwarded_for"';
    access_log /dev/stdout;
    error_log /dev/stdout;
    sendfile     on;
    tcp_nopush   on;
    server_names_hash_bucket_size 128; # this seems to be required for some vhosts


    client_max_body_size 20M;  # Modify this to fit you needs
    
    # Proxy settings
    proxy_buffer_size 16k;
    proxy_buffers 8 16k;
    proxy_busy_buffers_size 32k;
    proxy_headers_hash_max_size 1024;
    proxy_headers_hash_bucket_size 256;
    
    # FastCGI global settings (will be overridden in location block)
    fastcgi_connect_timeout 300;
    fastcgi_send_timeout 300;
    fastcgi_read_timeout 300;

    server {
        listen ${PORT};
        listen [::]:${PORT};
        server_name localhost;

        $if(NIXPACKS_PHP_ROOT_DIR) (
            root ${NIXPACKS_PHP_ROOT_DIR};
        ) else (
            root /app;
        )

        add_header X-Frame-Options "SAMEORIGIN";
        add_header X-Content-Type-Options "nosniff";

        index index.php;

        charset utf-8;

        location / {
            try_files $uri $uri/ /index.php?$query_string;
            # Cache static files for 1 year
            location ~* \.(css|js|jpg|jpeg|gif|png|ico|svg|woff|woff2|ttf|eot)$ {
                expires 1y;
                add_header Cache-Control "public, no-transform";
                try_files $uri $uri/ =404;
            }
        }

        location = /favicon.ico { access_log off; log_not_found off; }
        location = /robots.txt  { access_log off; log_not_found off; }

        $if(IS_LARAVEL) (
            error_page 404 /index.php;
        ) else ()

        location ~ \.php$ {
            fastcgi_pass 127.0.0.1:9000;
            fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
            include $!{nginx}/conf/fastcgi_params;
            include $!{nginx}/conf/fastcgi.conf;
            
            # FastCGI buffer settings
            fastcgi_buffer_size 64k;
            fastcgi_buffers 16 64k;
            fastcgi_busy_buffers_size 128k;
            
            # Buffer settings
            fastcgi_buffering on;
            
            # Hide sensitive headers
            fastcgi_hide_header X-Powered-By;
            fastcgi_hide_header X-CF-Powered-By;
            fastcgi_hide_header X-Runtime;
        }

        location ~ /\.(?!well-known).* {
            deny all;
        }
    }
}